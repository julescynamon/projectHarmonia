const t=document.getElementById("cart"),e=document.getElementById("closeCart"),n=document.getElementById("cartItems"),a=document.getElementById("cartTotal"),i=document.getElementById("checkout"),r=document.getElementById("cartError"),o=document.getElementById("cartLoading"),s=document.getElementById("emptyCart");async function d(){try{u(!0);const t=await fetch("/api/cart/items"),{data:e,error:n}=await t.json();if(n)return void l("Erreur lors de la récupération du panier");m(e||[])}catch(t){l("Erreur lors de la récupération du panier")}finally{u(!1)}}async function c(){if(n&&a&&s&&o)try{u(!0),r?.classList.add("hidden"),n.style.display="none",s.style.display="none";const t=await fetch("/api/cart/items");if(!t.ok)throw new Error("Erreur lors du chargement du panier");const e=await t.json();if(!e?.items?.length)return s.style.display="block",a.textContent="0.00 €",void(i&&(i.disabled=!0));n.style.display="block",m(e.items);const o=e.items.reduce(((t,e)=>t+e.quantity*(e.price||0)),0);a.textContent=`${o.toFixed(2)} €`,i&&(i.disabled=!1)}catch(t){l(t.message)}finally{u(!1)}}function l(t){r.textContent=t,r.classList.remove("invisible"),setTimeout((()=>r.classList.add("invisible")),3e3)}function u(t){o.classList.toggle("invisible",!t),n.classList.toggle("opacity-50",t)}function m(t){if(0===t.length)return n.innerHTML="",s.classList.remove("hidden"),a.textContent="0,00 €",void(i.disabled=!0);s.classList.add("hidden"),n.innerHTML=t.map((t=>`\n      <div class="flex items-center gap-4 p-4 card rounded-lg shadow-sm">\n        <div class="flex-1">\n          <h3 class="font-medium text-lg">${t.title||"Produit inconnu"}</h3>\n          <p class="text-gray-600 mb-1">Fichier: ${t.image||"Non disponible"}</p>\n          <p class="text-gray-800 font-semibold">${(t.price||0).toFixed(2)} €</p>\n        </div>\n        <button\n          type="button"\n          class="text-red-500 hover:text-red-600 p-2 transition-colors"\n          data-action="remove" data-item-id="${t.id}"\n          aria-label="Supprimer l'article"\n        >\n          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />\n          </svg>\n        </button>\n      </div>\n    `)).join(""),n.querySelectorAll("button").forEach((t=>{const e=t.getAttribute("data-action"),n=t.getAttribute("data-item-id"),a=t.getAttribute("data-quantity");"remove"===e&&n?t.onclick=()=>p.removeItem(n):"update"===e&&n&&a&&(t.onclick=()=>p.updateQuantity(n,parseInt(a,10)))}));const e=t.reduce(((t,e)=>t+(e.price||0)*e.quantity),0);a.textContent=`${e.toFixed(2)} €`,i.disabled=!1}e&&t&&e.addEventListener("click",(()=>{t.classList.add("translate-x-full")})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&t&&!t.classList.contains("translate-x-full")&&t.classList.add("translate-x-full")})),window.addEventListener("cart:updated",d),d();const p={removeItem(t){t&&(u(!0),fetch("/api/cart/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({itemId:t})}).then((t=>{if(!t.ok)throw new Error("Erreur lors de la suppression");return c()})).catch((t=>{l(t.message)})).finally((()=>u(!1))))},updateQuantity(t,e){e<1||(u(!0),fetch("/api/cart/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({itemId:t,quantity:e})}).then((t=>{if(!t.ok)throw new Error("Erreur lors de la mise à jour de la quantité");return c()})).catch((t=>{l(t.message)})).finally((()=>u(!1))))}};c(),window.addEventListener("cart:updated",c),i.addEventListener("click",(async()=>{try{i.disabled=!0,i.textContent="Traitement en cours...";const t=await fetch("/api/cart/items"),e=await t.json(),{items:n}=e;if(!n||!n.length)throw new Error("Votre panier est vide");const a=await fetch("/api/create-checkout-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:n})});if(!a.ok){const t=await a.json();throw new Error(t.message||"Erreur lors de la création de la session de paiement")}const{url:r}=await a.json();if(!r)throw new Error("URL de paiement non reçue");window.location.href=r}catch(t){l("Une erreur est survenue lors du paiement. Veuillez réessayer.")}finally{i&&(i.disabled=!1,i.textContent="Valider la commande")}}));

import{createClient as e}from"./index.DNpxeyR_.js";import"./_commonjsHelpers.CkY8qhWC.js";import"./preload-helper.Cat91CNq.js";const t=e("https://hvthtebjvmutuvzvttdb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2dGh0ZWJqdm11dHV2enZ0dGRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY2OTM5NTgsImV4cCI6MjA1MjI2OTk1OH0.gpI9njtvd6Mu_0wTnwfvtx0bFpUDNexuzwu3hgOGDdY");let n=1,a={};window.loadAppointments=async function(e=1){try{document.getElementById("appointments-list").innerHTML='<div class="text-center py-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-sage mx-auto"></div><p class="mt-2 text-ebony/60">Chargement...</p></div>';const t=new URLSearchParams({page:e.toString(),limit:"10"});a.status&&t.append("status",a.status),a.dateFrom&&t.append("dateFrom",a.dateFrom),a.dateTo&&t.append("dateTo",a.dateTo),a.client&&t.append("client",a.client);const n=await fetch(`/api/admin/appointments/list?${t}`),o=await n.json();if(!n.ok)throw new Error(o.error||"Erreur lors du chargement");!function(e,t){const n=document.getElementById("appointments-list");if(!e||0===e.length)return void(n.innerHTML='<div class="text-center py-8 text-ebony/60">Aucune r√©servation trouv√©e</div>');const a=e.map((e=>{const t={pending_approval:'<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">‚è≥ En attente</span>',pending:'<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-medium">üí≥ En attente de paiement</span>',confirmed:'<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">‚úÖ Confirm√©</span>',refused:'<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium">‚ùå Refus√©</span>',cancelled:'<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-medium">üö´ Annul√©</span>'}[e.status]||'<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-medium">‚ùì Inconnu</span>';const n=new Date(e.date).toLocaleDateString("fr-FR");return`\n        <div class="bg-white/80 rounded-lg p-6 border border-sage/10 hover:shadow-lg transition-shadow">\n          <div class="flex justify-between items-start mb-4">\n            <div>\n              <h3 class="font-heading text-lg text-ebony mb-2">${e.client_name}</h3>\n              <p class="text-ebony/60 text-sm">${e.client_email}</p>\n            </div>\n            <div class="text-right">\n              ${t}\n              <p class="text-xs text-ebony/40 mt-1">ID: ${e.id.slice(0,8)}...</p>\n            </div>\n          </div>\n          \n          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">\n            <div>\n              <span class="text-sm font-medium text-ebony/60">Service:</span>\n              <p class="text-ebony">${e.services?.title||"N/A"}</p>\n            </div>\n            <div>\n              <span class="text-sm font-medium text-ebony/60">Date:</span>\n              <p class="text-ebony">${n} √† ${e.time}</p>\n            </div>\n            <div>\n              <span class="text-sm font-medium text-ebony/60">Prix:</span>\n              <p class="text-ebony">${e.services?.price||"N/A"}‚Ç¨</p>\n            </div>\n          </div>\n          \n          ${e.reason?`\n            <div class="mb-4">\n              <span class="text-sm font-medium text-ebony/60">Motif:</span>\n              <p class="text-ebony text-sm">${e.reason}</p>\n            </div>\n          `:""}\n          \n          <div class="flex justify-end space-x-2">\n            ${"pending_approval"===e.status?`\n              <button onclick="approveAppointment('${e.id}')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm">\n                ‚úÖ Approuver\n              </button>\n              <button onclick="rejectAppointment('${e.id}')" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm">\n                ‚ùå Refuser\n              </button>\n            `:""}\n            ${"pending"===e.status?'\n              <span class="text-orange-600 text-sm font-medium">‚è≥ En attente de paiement</span>\n            ':""}\n            ${"confirmed"===e.status?'\n              <span class="text-green-600 text-sm font-medium">‚úÖ Confirm√©</span>\n            ':""}\n            ${"refused"===e.status?'\n              <span class="text-red-600 text-sm font-medium">‚ùå Refus√©</span>\n            ':""}\n          </div>\n        </div>\n      `})).join("");n.innerHTML=a,function(e){const t=document.getElementById("pagination");if(!e||e.totalPages<=1)return void(t.innerHTML="");let n="";e.hasPrevPage&&(n+=`<button onclick="loadAppointments(${e.page-1})" class="px-3 py-2 text-sage hover:text-sage/80 transition-colors">‚Üê Pr√©c√©dent</button>`);for(let a=1;a<=e.totalPages;a++)a===e.page?n+=`<span class="px-3 py-2 bg-sage text-white rounded-lg">${a}</span>`:n+=`<button onclick="loadAppointments(${a})" class="px-3 py-2 text-ebony/60 hover:text-ebony transition-colors">${a}</button>`;e.hasNextPage&&(n+=`<button onclick="loadAppointments(${e.page+1})" class="px-3 py-2 text-sage hover:text-sage/80 transition-colors">Suivant ‚Üí</button>`);t.innerHTML=n}(t)}(o.data,o.pagination)}catch(t){document.getElementById("appointments-list").innerHTML='<div class="text-center py-8 text-red-600">Erreur lors du chargement des r√©servations</div>'}},window.approveAppointment=async e=>{if(confirm("√ätes-vous s√ªr de vouloir approuver cette r√©servation ?"))try{const t=await fetch("/api/admin/appointments/approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({appointmentId:e})}),a=await t.json();if(!t.ok)throw new Error(a.error||"Erreur lors de l'approbation");alert("R√©servation approuv√©e avec succ√®s ! Un email avec le lien de paiement a √©t√© envoy√© au client."),window.loadAppointments(n)}catch(t){alert("Erreur lors de l'approbation : "+t.message)}},window.rejectAppointment=async e=>{const t=prompt("Veuillez indiquer la raison du refus :");if(t&&confirm("√ätes-vous s√ªr de vouloir refuser cette r√©servation ?"))try{const a=await fetch("/api/admin/appointments/reject",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({appointmentId:e,rejectionReason:t})}),o=await a.json();if(!a.ok)throw new Error(o.error||"Erreur lors du refus");alert("R√©servation refus√©e avec succ√®s ! Un email a √©t√© envoy√© au client."),window.loadAppointments(n)}catch(a){alert("Erreur lors du refus : "+a.message)}};const o=(new Date).toISOString().split("T")[0];document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("startDate"),t=document.getElementById("endDate");e&&(e.min=o,e.addEventListener("change",(function(){t&&(t.min=this.value)}))),t&&(t.min=o)}));const s=document.getElementById("block-time-form");s.addEventListener("submit",(async e=>{e.preventDefault();const n=new FormData(s);try{const e=n.get("startDate"),a=n.get("endDate"),r=n.get("startTime"),d=n.get("endTime"),i=new Date(`${e} ${r}`),c=new Date(`${a} ${d}`),l=new Date;if(i<=l)throw new Error("La date de d√©but doit √™tre dans le futur");if(c<=l)throw new Error("La date de fin doit √™tre dans le futur");if(i>=c)throw new Error("La date de fin doit √™tre post√©rieure √† la date de d√©but");const m=await async function(e,n,a,o){try{const{data:s,error:r}=await t.from("blocked_times").select("*").or(`start_date.lte.${n},end_date.gte.${e}`);if(r)throw r;if(s&&s.length>0)for(const t of s){const s=new Date(`${e} ${a}`),r=new Date(`${n} ${o}`),d=new Date(`${t.start_date} ${t.start_time}`);if(s<new Date(`${t.end_date} ${t.end_time}`)&&r>d)return{hasOverlap:!0,conflictingBlock:t}}return{hasOverlap:!1}}catch(u){throw u}}(e,a,r,d);if(m.hasOverlap){const e=m.conflictingBlock;throw new Error(`Cette plage chevauche une p√©riode d√©j√† bloqu√©e (du ${e.start_date} ${e.start_time} au ${e.end_date} ${e.end_time})`)}const{data:p,error:u}=await t.from("blocked_times").insert([{start_date:e,end_date:a,start_time:r,end_time:d,reason:n.get("reason")||null}]).select();if(u)throw u;alert("Plage horaire bloqu√©e avec succ√®s"),s.reset();const g=document.getElementById("startDate"),f=document.getElementById("endDate");g&&(g.min=o),f&&(f.min=o),await window.loadBlockedTimes()}catch(a){alert(a instanceof Error?a.message:"Erreur lors du blocage de la plage horaire")}}));const r=document.getElementById("block-day-form");r.addEventListener("submit",(async e=>{e.preventDefault();const n=new FormData(r);try{const e=n.get("startDate"),a=n.get("endDate"),s=n.get("reason"),d=new Date(e),i=new Date(a),c=new Date;if(d<=c)throw new Error("La date de d√©but doit √™tre dans le futur");if(i<=c)throw new Error("La date de fin doit √™tre dans le futur");if(d>=i)throw new Error("La date de fin doit √™tre post√©rieure √† la date de d√©but");const{data:l,error:m}=await t.from("blocked_times").select("*").or(`start_date.lte.${a},end_date.gte.${e}`);if(m)throw m;if(l&&l.length>0)for(const t of l){const e=new Date(t.start_date);if(d<=new Date(t.end_date)&&i>=e)throw new Error(`Cette p√©riode chevauche une p√©riode d√©j√† bloqu√©e (du ${t.start_date} au ${t.end_date})`)}const{data:p,error:u}=await t.from("blocked_times").insert([{start_date:e,end_date:a,start_time:"00:00",end_time:"23:59",reason:s||"Vacances"}]).select();if(u)throw u;alert(`P√©riode de vacances bloqu√©e avec succ√®s du ${e} au ${a}`),r.reset();const g=document.getElementById("vacationStartDate"),f=document.getElementById("vacationEndDate");g&&(g.min=o),f&&(f.min=o),await window.loadBlockedTimes()}catch(a){alert(a instanceof Error?a.message:"Erreur lors du blocage de la p√©riode de vacances")}})),window.loadBlockedTimes=async function(){try{const{data:e,error:n}=await t.from("blocked_times").select("*").order("start_date",{ascending:!0});if(n)return;const a=document.getElementById("calendar-manager");if(!a||!e)return;a.innerHTML=`\n        <div class="space-y-4">\n          <h2 class="font-heading text-2xl text-ebony mb-4">P√©riodes bloqu√©es</h2>\n          ${0===e.length?'<p class="text-sage">Aucune p√©riode bloqu√©e</p>':`<div class="grid gap-4">\n              ${e.map((e=>{const t="00:00"===e.start_time&&"23:59"===e.end_time;return`\n                  <div class="p-4 ${t?"bg-orange-50 border border-orange-200":"bg-sage/5"} rounded-lg">\n                    <div class="flex justify-between items-start">\n                      <div class="flex-1">\n                        <div class="flex items-center gap-2 mb-2">\n                          <span class="px-2 py-1 rounded-full text-xs font-medium ${t?"bg-orange-100 text-orange-800":"bg-sage/10 text-sage"}">${t?"üèñÔ∏è Vacances":"‚è∞ Cr√©neau"}</span>\n                        </div>\n                        <p class="font-medium">Du ${new Date(e.start_date).toLocaleDateString()} ${t?"":`√† ${e.start_time}`}</p>\n                        <p class="font-medium">Au ${new Date(e.end_date).toLocaleDateString()} ${t?"":`√† ${e.end_time}`}</p>\n                        ${e.reason?`<p class="text-sage mt-2 font-medium">${e.reason}</p>`:""}\n                      </div>\n                      <button \n                        class="text-red-500 hover:text-red-700 transition-colors ml-4"\n                        onclick="deletePeriod('${e.id}')"\n                        title="Supprimer cette p√©riode"\n                      >\n                        üóëÔ∏è\n                      </button>\n                    </div>\n                  </div>\n                `})).join("")}\n            </div>`}\n        </div>\n      `}catch(e){alert("Erreur lors du chargement des p√©riodes bloqu√©es")}},window.deletePeriod=async e=>{if(confirm("Voulez-vous vraiment supprimer cette p√©riode ?"))try{const{error:n}=await t.from("blocked_times").delete().eq("id",e);if(n)throw n;alert("P√©riode supprim√©e avec succ√®s"),await window.loadBlockedTimes()}catch(n){alert("Erreur lors de la suppression de la p√©riode")}},document.addEventListener("DOMContentLoaded",(function(){!function(){const e=document.querySelectorAll(".tab-button"),t=document.querySelectorAll(".tab-content");e.forEach((n=>{n.addEventListener("click",(()=>{const a=n.id.replace("tab-","")+"-tab";e.forEach((e=>{e.classList.remove("active","border-sage","text-sage"),e.classList.add("border-transparent","text-ebony/60")})),n.classList.add("active","border-sage","text-sage"),n.classList.remove("border-transparent","text-ebony/60"),t.forEach((e=>{e.classList.add("hidden")})),document.getElementById(a).classList.remove("hidden"),"appointments-tab"===a?window.loadAppointments():"availability-tab"===a&&window.loadBlockedTimes()}))}))}(),function(){const e=document.getElementById("apply-filters"),t=document.getElementById("clear-filters");e.addEventListener("click",(()=>{a={status:document.getElementById("status-filter").value,dateFrom:document.getElementById("date-from-filter").value,dateTo:document.getElementById("date-to-filter").value,client:document.getElementById("client-search").value},n=1,window.loadAppointments(n)})),t.addEventListener("click",(()=>{document.getElementById("status-filter").value="",document.getElementById("date-from-filter").value="",document.getElementById("date-to-filter").value="",document.getElementById("client-search").value="",a={},n=1,window.loadAppointments(n)}))}(),window.loadAppointments(),window.loadBlockedTimes();const e=document.getElementById("vacationStartDate"),t=document.getElementById("vacationEndDate");e&&(e.min=o),t&&(t.min=o)}));

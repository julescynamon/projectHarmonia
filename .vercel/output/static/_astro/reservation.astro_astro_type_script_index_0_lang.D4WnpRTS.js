document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("date");if(e&&e instanceof HTMLInputElement){const t=(new Date).toISOString().split("T")[0];e.min=t}})),setTimeout((()=>{const e=document.getElementById("hero-typewriter");if(e){!function(e,t,n=80){let r=0;e.innerHTML="",function s(){r<t.length&&(e.innerHTML+=t.charAt(r),r++,setTimeout(s,n))}()}(e,e.textContent,80)}}),1500);const e=document.getElementById("appointmentForm"),t=document.getElementById("date"),n=document.getElementById("timeSlots");async function r(e){try{const t=await fetch("/api/appointments/unavailable-times",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:e})});if(!t.ok)throw new Error(`Erreur HTTP: ${t.status} ${t.statusText}`);return(await t.json()).unavailableTimes||[]}catch(t){return function(e){e.message,(new Date).toISOString(),navigator.userAgent,window.location.href,document.referrer}(t),["09:00","10:30","12:00","14:00","15:30","17:00"]}}async function s(){const e=t.value;if(!e)return;const s=n.querySelectorAll('input[type="radio"]'),a=document.createElement("div");a.className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 text-sm",a.innerHTML='\n      <div class="flex items-center">\n        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>\n        <span>Vérification de la disponibilité...</span>\n      </div>\n    ';n.parentElement.querySelectorAll(".bg-red-50, .bg-blue-50, .bg-green-50").forEach((e=>e.remove())),n.parentElement.appendChild(a),s.forEach((e=>{e.disabled=!0,e.checked=!1;e.parentElement.classList.add("opacity-50","cursor-not-allowed")}));try{const t=await r(e);let o=!1,i=!0;for(const e of s){const n=e.value+":00",r=!t.includes(n),s=e.parentElement;if(r){s.classList.remove("opacity-50","cursor-not-allowed","bg-red-50","border-red-300"),s.classList.add("cursor-pointer","hover:bg-sage/5","hover:border-sage/40"),e.disabled=!1,i=!1;const t=s.querySelector(".time-slot-status");t&&t.classList.add("hidden")}else{s.classList.add("opacity-50","cursor-not-allowed","bg-red-50","border-red-300"),s.classList.remove("cursor-pointer","hover:bg-sage/5","hover:border-sage/40"),e.disabled=!0,e.checked=!1,o=!0;const t=s.querySelector(".time-slot-status");t&&(t.classList.remove("hidden"),t.textContent="Indisponible",t.className="time-slot-status absolute -top-2 -right-2 bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full shadow-sm z-10"),s.offsetHeight}}if(a.remove(),i){const e=document.createElement("div");e.className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",e.innerHTML='\n          <div class="flex items-center">\n            <span class="material-icons mr-2 text-red-500">event_busy</span>\n            <span>Aucun créneau disponible pour cette date. Veuillez choisir une autre date.</span>\n          </div>\n        ',n.parentElement.appendChild(e)}else if(o){const e=document.createElement("div");e.className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm",e.innerHTML='\n          <div class="flex items-center">\n            <span class="material-icons mr-2 text-green-500">check_circle</span>\n            <span>Créneaux disponibles mis à jour. Les créneaux grisés sont indisponibles.</span>\n          </div>\n        ',n.parentElement.appendChild(e)}}catch(o){a.remove();const e=document.createElement("div");e.className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",e.innerHTML='\n        <div class="flex items-center">\n          <span class="material-icons mr-2 text-red-500">warning</span>\n          <span>Impossible de vérifier la disponibilité des créneaux. Veuillez réessayer ou nous contacter.</span>\n        </div>\n      ',n.parentElement.appendChild(e),s.forEach((e=>{e.disabled=!1;e.parentElement.classList.remove("opacity-50","cursor-not-allowed")}))}}t&&t.addEventListener("change",s),t&&t.value&&s(),e&&e.addEventListener("submit",(async n=>{n.preventDefault();const s=t.value,a=e.querySelector('input[name="time"]:checked')?.value,o=e.querySelector('input[name="service"]:checked')?.value,i=e.querySelector('input[name="name"]')?.value,c=e.querySelector('input[name="email"]')?.value,l=e.querySelector('textarea[name="reason"]')?.value;if(s&&a&&o&&i&&c)try{const e=await r(s);if(!!e.includes(a))return void alert("Désolé, ce créneau n'est plus disponible. Veuillez en choisir un autre.");const t=await fetch("/api/appointments/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:s,time:a,serviceId:o,name:i,email:c,reason:l})}),n=await t.json();if(!t.ok||!n.success)throw new Error(n.error||"Erreur lors de la création du rendez-vous");alert("Votre demande de réservation a été enregistrée avec succès ! Vous recevrez un email de confirmation dans quelques instants."),window.location.href="/accompagnements/reservation?success=true"}catch(d){alert("Une erreur est survenue. Veuillez réessayer.")}else alert("Veuillez remplir tous les champs du formulaire")})),document.addEventListener("DOMContentLoaded",(function(){document.querySelectorAll('a[href="#reservation-form"][data-service]').forEach((e=>{e.addEventListener("click",(function(e){e.preventDefault();const t=this.getAttribute("data-service");if(!t)return;const n=document.getElementById("reservation-form");n&&(n.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout((()=>{const e=document.querySelector(`input[name="service"][value="${t}"]`);if(e){e.checked=!0;const t=e.closest("label");t&&(document.querySelectorAll('input[name="service"]').forEach((e=>{const t=e.closest("label");t&&t.classList.remove("ring-2","ring-sage","ring-offset-2","bg-sage/10")})),t.classList.add("ring-2","ring-sage","ring-offset-2","bg-sage/10"),setTimeout((()=>{t.classList.remove("ring-2","ring-sage","ring-offset-2","bg-sage/10")}),3e3))}}),500))}))}))}));

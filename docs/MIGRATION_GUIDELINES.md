# Guide des Migrations Supabase - La Maison Sattva√Øa

Ce document d√©crit les bonnes pratiques et conventions pour g√©rer les migrations de base de donn√©es avec Supabase dans le projet La Maison Sattva√Øa.

## üìã Table des Mati√®res

- [Convention de Nommage](#convention-de-nommage)
- [Structure des Migrations](#structure-des-migrations)
- [Scripts d'Automatisation](#scripts-dautomatisation)
- [Workflow de Migration](#workflow-de-migration)
- [Bonnes Pratiques](#bonnes-pratiques)
- [Exemples de Migrations](#exemples-de-migrations)
- [D√©pannage](#d√©pannage)

## üè∑Ô∏è Convention de Nommage

### Format Standard

```
YYYYMMDDHHMMSS_description_en_snake_case.sql
```

### Exemples

- `20250120143000_ajouter_table_utilisateurs.sql`
- `20250120144530_modifier_colonne_email.sql`
- `20250120150000_creer_index_performance.sql`

### R√®gles de Nommage

- **Timestamp** : Format ISO sans s√©parateurs (YYYYMMDDHHMMSS)
- **Description** : En minuscules, mots s√©par√©s par des underscores
- **Extension** : Toujours `.sql`
- **Longueur** : Maximum 100 caract√®res pour le nom complet

## üìÅ Structure des Migrations

### En-t√™te Obligatoire

```sql
-- Migration: [Description claire et concise]
-- Date: [Date de cr√©ation]
-- Auteur: [Nom du d√©veloppeur]
-- Version: [Timestamp de la migration]
-- Type: [CREATE|ALTER|DROP|DATA]
```

### Sections Recommand√©es

```sql
-- =====================================================
-- DESCRIPTION: [Description d√©taill√©e]
-- =====================================================

-- OBJECTIFS:
-- - [Objectif 1]
-- - [Objectif 2]

-- IMPACT:
-- - [Impact sur les performances]
-- - [Impact sur les donn√©es existantes]

-- =====================================================
-- MIGRATION SQL
-- =====================================================

-- [Code SQL principal]

-- =====================================================
-- VALIDATION
-- =====================================================

-- [Requ√™tes de validation]

-- =====================================================
-- ROLLBACK (optionnel)
-- =====================================================

-- [Instructions de rollback]
```

## ü§ñ Scripts d'Automatisation

### Script Bash (`scripts/migration-helper.sh`)

```bash
# Cr√©er une nouvelle migration
./scripts/migration-helper.sh create "ajouter table utilisateurs"

# Lister les migrations
./scripts/migration-helper.sh list

# Appliquer les migrations
./scripts/migration-helper.sh apply

# Valider les migrations
./scripts/migration-helper.sh validate

# G√©n√©rer un rapport
./scripts/migration-helper.sh report
```

### Script Node.js (`scripts/migration-workflow.js`)

```bash
# Mode interactif
node scripts/migration-workflow.js interactive

# Cr√©er une migration
node scripts/migration-workflow.js create "ajouter table utilisateurs"

# Lister les migrations
node scripts/migration-workflow.js list
```

## üîÑ Workflow de Migration

### 1. Pr√©paration

```bash
# D√©marrer Supabase localement
supabase start

# V√©rifier l'√©tat
supabase status
```

### 2. Cr√©ation de Migration

```bash
# Utiliser le script automatis√©
./scripts/migration-helper.sh create "description de la migration"

# Ou utiliser Supabase CLI directement
supabase migration new nom_de_la_migration
```

### 3. D√©veloppement

- √âditer le fichier de migration g√©n√©r√©
- Tester localement avec `supabase db reset`
- Valider la syntaxe avec `./scripts/migration-helper.sh validate`

### 4. Application

```bash
# Appliquer les migrations
supabase db reset

# Ou utiliser le script
./scripts/migration-helper.sh apply
```

### 5. Validation

```bash
# V√©rifier que tout fonctionne
supabase db diff

# G√©n√©rer un rapport
./scripts/migration-helper.sh report
```

## ‚úÖ Bonnes Pratiques

### S√©curit√©

- ‚úÖ Utilisez `IF NOT EXISTS` pour √©viter les erreurs
- ‚úÖ Utilisez `IF EXISTS` pour les suppressions
- ‚úÖ Activez RLS sur toutes les tables utilisateur
- ‚úÖ Documentez les politiques de s√©curit√©
- ‚ùå √âvitez `DROP TABLE` sans sauvegarde
- ‚ùå √âvitez les modifications de donn√©es sans `WHERE`

### Performance

- ‚úÖ Ajoutez des index pour les colonnes fr√©quemment utilis√©es
- ‚úÖ Utilisez des index partiels quand appropri√©
- ‚úÖ Optimisez les requ√™tes complexes
- ‚ùå √âvitez les index inutiles

### Maintenabilit√©

- ‚úÖ Documentez chaque migration
- ‚úÖ Incluez des instructions de rollback
- ‚úÖ Testez sur un environnement de d√©veloppement
- ‚úÖ Utilisez des transactions pour les migrations complexes
- ‚úÖ Ajoutez des commentaires explicatifs

### Exemples de Bonnes Pratiques

#### Cr√©ation de Table

```sql
-- ‚úÖ Bon
CREATE TABLE IF NOT EXISTS utilisateurs (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Cr√©er des index pour les performances
CREATE INDEX IF NOT EXISTS idx_utilisateurs_email ON utilisateurs(email);

-- Activer RLS
ALTER TABLE utilisateurs ENABLE ROW LEVEL SECURITY;

-- Ajouter des politiques de s√©curit√©
CREATE POLICY "Users can view own data" ON utilisateurs
    FOR SELECT USING (auth.uid() = id);
```

#### Modification de Table

```sql
-- ‚úÖ Bon
ALTER TABLE utilisateurs
ADD COLUMN IF NOT EXISTS nom VARCHAR(255),
ADD COLUMN IF NOT EXISTS prenom VARCHAR(255);

-- Ajouter un index pour la recherche
CREATE INDEX IF NOT EXISTS idx_utilisateurs_nom_prenom
ON utilisateurs(nom, prenom);
```

## üìù Exemples de Migrations

### Exemple 1: Cr√©ation de Table Simple

```sql
-- Migration: Ajouter table produits
-- Date: 2025-01-20 14:30:00
-- Auteur: Jules Dupont
-- Version: 20250120143000
-- Type: CREATE

-- =====================================================
-- DESCRIPTION: Cr√©ation de la table produits pour la boutique
-- =====================================================

-- OBJECTIFS:
-- - Stocker les informations des produits
-- - Permettre la gestion du catalogue
-- - Supporter les images et descriptions

-- IMPACT:
-- - Nouvelle table cr√©√©e
-- - Aucun impact sur les donn√©es existantes

-- =====================================================
-- MIGRATION SQL
-- =====================================================

CREATE TABLE IF NOT EXISTS produits (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nom VARCHAR(255) NOT NULL,
    description TEXT,
    prix DECIMAL(10,2) NOT NULL CHECK (prix >= 0),
    stock INTEGER DEFAULT 0 CHECK (stock >= 0),
    image_url TEXT,
    categorie VARCHAR(100),
    actif BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index pour les performances
CREATE INDEX IF NOT EXISTS idx_produits_categorie ON produits(categorie);
CREATE INDEX IF NOT EXISTS idx_produits_actif ON produits(actif) WHERE actif = true;
CREATE INDEX IF NOT EXISTS idx_produits_prix ON produits(prix);

-- RLS
ALTER TABLE produits ENABLE ROW LEVEL SECURITY;

-- Politiques de s√©curit√©
CREATE POLICY "Public can view active products" ON produits
    FOR SELECT USING (actif = true);

CREATE POLICY "Admins can manage products" ON produits
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM profiles
            WHERE profiles.id = auth.uid()
            AND profiles.role = 'admin'
        )
    );

-- =====================================================
-- VALIDATION
-- =====================================================

-- V√©rifier que la table a √©t√© cr√©√©e
SELECT COUNT(*) FROM produits;

-- V√©rifier les index
SELECT indexname FROM pg_indexes WHERE tablename = 'produits';

-- =====================================================
-- ROLLBACK
-- =====================================================

-- DROP TABLE IF EXISTS produits CASCADE;
```

### Exemple 2: Modification de Table

```sql
-- Migration: Ajouter colonnes SEO aux produits
-- Date: 2025-01-20 15:00:00
-- Auteur: Jules Dupont
-- Version: 20250120150000
-- Type: ALTER

-- =====================================================
-- DESCRIPTION: Ajout de colonnes SEO pour optimiser le r√©f√©rencement
-- =====================================================

-- OBJECTIFS:
-- - Am√©liorer le SEO des produits
-- - Permettre des URLs personnalis√©es
-- - Ajouter des m√©tadonn√©es

-- IMPACT:
-- - Nouvelles colonnes ajout√©es
-- - Aucun impact sur les donn√©es existantes

-- =====================================================
-- MIGRATION SQL
-- =====================================================

-- Ajouter les colonnes SEO
ALTER TABLE produits
ADD COLUMN IF NOT EXISTS slug VARCHAR(255),
ADD COLUMN IF NOT EXISTS meta_title VARCHAR(255),
ADD COLUMN IF NOT EXISTS meta_description TEXT,
ADD COLUMN IF NOT EXISTS keywords TEXT;

-- Cr√©er un index unique sur le slug
CREATE UNIQUE INDEX IF NOT EXISTS idx_produits_slug ON produits(slug) WHERE slug IS NOT NULL;

-- Index pour la recherche par mots-cl√©s
CREATE INDEX IF NOT EXISTS idx_produits_keywords ON produits USING GIN(to_tsvector('french', keywords));

-- =====================================================
-- VALIDATION
-- =====================================================

-- V√©rifier que les colonnes ont √©t√© ajout√©es
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'produits'
AND column_name IN ('slug', 'meta_title', 'meta_description', 'keywords');

-- =====================================================
-- ROLLBACK
-- =====================================================

-- ALTER TABLE produits DROP COLUMN IF EXISTS slug;
-- ALTER TABLE produits DROP COLUMN IF EXISTS meta_title;
-- ALTER TABLE produits DROP COLUMN IF EXISTS meta_description;
-- ALTER TABLE produits DROP COLUMN IF EXISTS keywords;
```

## üîß D√©pannage

### Erreurs Courantes

#### Migration d√©j√† appliqu√©e

```bash
# V√©rifier l'√©tat des migrations
supabase migration list

# R√©initialiser si n√©cessaire
supabase db reset
```

#### Conflit de noms

```bash
# Renommer la migration
mv supabase/migrations/ancien_nom.sql supabase/migrations/nouveau_nom.sql
```

#### Erreur de syntaxe SQL

```bash
# Valider la syntaxe
./scripts/migration-helper.sh validate

# Tester localement
supabase db reset
```

### Commandes Utiles

```bash
# Voir les diff√©rences avec la base de production
supabase db diff

# G√©n√©rer une migration √† partir des diff√©rences
supabase db diff --schema public > migration_auto.sql

# Voir l'√©tat de Supabase
supabase status

# Red√©marrer Supabase
supabase stop && supabase start
```

## üìö Ressources

- [Documentation Supabase CLI](https://supabase.com/docs/guides/cli)
- [Guide des Migrations Supabase](https://supabase.com/docs/guides/database/migrations)
- [Bonnes Pratiques PostgreSQL](https://www.postgresql.org/docs/current/index.html)

## ü§ù Contribution

Pour contribuer aux migrations :

1. Suivez les conventions de nommage
2. Documentez vos changements
3. Testez localement avant de soumettre
4. Utilisez les scripts d'automatisation
5. Validez la syntaxe SQL

---

**Note** : Ce guide est un document vivant qui sera mis √† jour selon les besoins du projet.

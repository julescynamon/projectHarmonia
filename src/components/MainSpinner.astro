---
---
<!-- Spinner -->
<div class="loading-overlay" id="loadingOverlay">
  <img src="/images/arbre-de-vie-01.svg" alt="Chargement..." class="spinner" />
</div>

<script is:inline>
  let loadingTimer = null;
  let navigationTimer = null;
  const LOADING_DELAY = 300; // Délai avant d'afficher le spinner (en ms)

  // Fonction pour montrer le spinner
  function showSpinner() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.classList.add('visible');
    }
  }

  // Fonction pour cacher le spinner
  function hideSpinner() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.classList.remove('visible');
    }
  }

  // Gestion des requêtes AJAX
  const originalFetch = window.fetch;
  let activeRequests = 0;

  window.fetch = async function(...args) {
    activeRequests++;
    
    if (activeRequests === 1) {
      // Démarrer le timer pour le spinner
      loadingTimer = setTimeout(() => {
        showSpinner();
      }, LOADING_DELAY);
    }

    try {
      const response = await originalFetch.apply(this, args);
      return response;
    } finally {
      activeRequests--;
      
      if (activeRequests === 0) {
        // Annuler le timer si la requête est rapide
        clearTimeout(loadingTimer);
        hideSpinner();
      }
    }
  };

  // Événements de navigation
  document.addEventListener('astro:before-preparation', () => {
    navigationTimer = setTimeout(() => {
      showSpinner();
    }, LOADING_DELAY);
  });

  document.addEventListener('astro:after-preparation', () => {
    clearTimeout(navigationTimer);
    hideSpinner();
  });

  // Gestion du chargement initial de la page
  let initialLoadTimer = null;
  
  if (document.readyState === 'loading') {
    initialLoadTimer = setTimeout(() => {
      showSpinner();
    }, LOADING_DELAY);
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (initialLoadTimer) {
      clearTimeout(initialLoadTimer);
      hideSpinner();
    }
  });

  // S'assurer que le spinner est caché si la page est déjà chargée
  if (document.readyState === 'complete') {
    hideSpinner();
  }
</script>

---
// Page de test pour diagnostiquer l'accès admin
// src/pages/test-admin-access.astro

import MainLayout from '../layouts/MainLayout.astro';
const supabase = Astro.locals.supabase;
const session = Astro.locals.session;

console.log('[TEST_ADMIN] Session:', JSON.stringify(session, null, 2));

// Test de la base de données
let testResults = [];

try {
  // 1. Test de la table profiles
  const { data: profiles, error: profilesError } = await supabase
    .from('profiles')
    .select('*')
    .limit(1);
  
  testResults.push({
    test: 'Table profiles',
    success: !profilesError,
    error: profilesError?.message,
    data: profiles?.length > 0 ? Object.keys(profiles[0]) : []
  });

    // 2. Test de l'utilisateur tyzranaima@gmail.com
  if (session?.user?.email === 'tyzranaima@gmail.com') {
    testResults.push({
      test: 'Utilisateur tyzranaima@gmail.com',
      success: true,
      error: null,
      data: [session.user.id, session.user.email]
    });

    // 3. Test du profil admin (optionnel pour l'admin principal)
    testResults.push({
      test: 'Profil admin',
      success: true,
      error: null,
      data: ['admin (accès direct par email)']
    });
  } else {
    testResults.push({
      test: 'Utilisateur tyzranaima@gmail.com',
      success: false,
      error: 'Utilisateur non connecté ou email différent',
      data: [session?.user?.email || 'Non connecté']
    });
  }

  // 4. Test de la table posts
  const { data: posts, error: postsError } = await supabase
    .from('posts')
    .select('*')
    .limit(1);
  
  testResults.push({
    test: 'Table posts',
    success: !postsError,
    error: postsError?.message,
    data: posts?.length > 0 ? Object.keys(posts[0]) : []
  });

  // 5. Test du bucket blog-images
  const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();
  
  testResults.push({
    test: 'Bucket blog-images',
    success: !bucketsError && buckets?.some(b => b.name === 'blog-images'),
    error: bucketsError?.message,
    data: buckets?.map(b => `${b.name} (public: ${b.public})`) || []
  });

} catch (error) {
  testResults.push({
    test: 'Erreur générale',
    success: false,
    error: error.message,
    data: []
  });
}
---

<MainLayout title="Test Accès Admin" description="Page de test pour diagnostiquer l'accès admin">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">Test d'Accès Admin</h1>
    
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-4">Session Utilisateur</h2>
      <div class="bg-gray-100 p-4 rounded-lg">
        <pre class="text-sm overflow-auto">{JSON.stringify(session, null, 2)}</pre>
      </div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-4">Tests de Base de Données</h2>
      <div class="space-y-4">
        {testResults.map((result) => (
          <div class={`p-4 rounded-lg border ${result.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-medium">{result.test}</h3>
              <span class={`px-2 py-1 rounded text-xs font-medium ${result.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                {result.success ? '✅ Succès' : '❌ Échec'}
              </span>
            </div>
            {result.error && (
              <p class="text-red-600 text-sm mb-2">Erreur: {result.error}</p>
            )}
            {result.data.length > 0 && (
              <div class="text-sm text-gray-600">
                <strong>Données:</strong> {result.data.join(', ')}
              </div>
            )}
          </div>
        ))}
      </div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-4">Actions</h2>
      <div class="space-x-4">
        <a href="/admin/blog" class="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          Tester /admin/blog
        </a>
        <a href="/mon-compte" class="inline-block px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
          Retour Mon Compte
        </a>
      </div>
    </div>
  </div>
</MainLayout>
